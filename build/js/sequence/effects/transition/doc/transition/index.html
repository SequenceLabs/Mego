<!DOCTYPE html><html lang="en"><head><title>transition</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content=""><meta name="groc-document-path" content="transition"><meta name="groc-project-path" content="transition.coffee"><link rel="stylesheet" type="text/css" media="all" href="assets/style.css"><script type="text/javascript" src="assets/behavior.js"></script><body><div id="meta"><div class="file-path">transition.coffee</div></div><div id="document"><div class="segment"><div class="comments"><div class="wrapper"><h1 id="transition">TRANSITION</h1></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>Transition is CSS3 Transition engine with jQuery fallback. </p></div></div><div class="code"><div class="wrapper"><span class="s2">&quot;use strict&quot;</span>  

<span class="nv">effects = </span><span class="nx">SEQ</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">namespace</span> <span class="s2">&quot;effects&quot;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>list of transitionEnd event names</p></div></div><div class="code"><div class="wrapper"><span class="nv">transitionEndNames =</span>
  <span class="nv">WebkitTransition: </span><span class="s1">&#39;webkitTransitionEnd&#39;</span>
  <span class="nv">MozTransition: </span><span class="s1">&#39;transitionend&#39;</span>
  <span class="nv">OTransition: </span><span class="s1">&#39;oTransitionEnd&#39;</span>
  <span class="nv">msTransition: </span><span class="s1">&#39;msTransitionEnd&#39;</span>
  <span class="nv">transition: </span><span class="s1">&#39;transitionEnd&#39;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>utility function for getting vendor-prefixed property     </p></div></div><div class="code"><div class="wrapper"><span class="nv">getProp = </span><span class="nf">(prop) -&gt;</span>  
  <span class="k">for</span> <span class="nx">prefix</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Webkit&quot;</span><span class="p">,</span> <span class="s2">&quot;Moz&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">,</span> <span class="s2">&quot;ms&quot;</span><span class="p">,</span> <span class="s2">&quot;Khtml&quot;</span><span class="p">]</span> 
    <span class="nv">p = </span><span class="s2">&quot;#{prefix}#{prop}&quot;</span>
    <span class="k">return</span> <span class="nx">p</span> <span class="k">if</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="o">?</span>

<span class="k">class</span> <span class="nx">effects</span><span class="p">.</span><span class="nx">Transition</span> 
  <span class="vi">@To: </span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>apply delay, if present</p></div></div><div class="code"><div class="wrapper">    <span class="nv">t = </span><span class="nx">setTimeout</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if browser supports CSS3 Transitions</p></div></div><div class="code"><div class="wrapper">      <span class="k">if</span> <span class="nx">getProp</span><span class="p">(</span><span class="s2">&quot;Transition&quot;</span><span class="p">)</span><span class="o">?</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>start the magic</p></div></div><div class="code"><div class="wrapper">        <span class="k">new</span> <span class="nx">effects</span><span class="p">.</span><span class="nx">CSSTransition</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
      <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>rock it old-skool</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@jqAnimate</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span>
      <span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span>      
    <span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">delay</span> <span class="o">or</span> <span class="mi">0</span>   
  
  <span class="vi">@jqAnimate: </span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if jQuery object</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">jQuery</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>use that</p></div></div><div class="code"><div class="wrapper">      <span class="nv">target = </span><span class="nx">options</span><span class="p">.</span><span class="nx">target</span>
    <span class="k">else</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>create one</p></div></div><div class="code"><div class="wrapper">      <span class="nv">target = </span><span class="nx">$</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>pass user options unti jQuery animation API</p></div></div><div class="code"><div class="wrapper">    <span class="nx">target</span><span class="p">.</span><span class="nx">animate</span><span class="p">(</span>
      <span class="nx">options</span><span class="p">.</span><span class="nx">props</span>
    <span class="p">,</span> 
      <span class="nv">duration: </span><span class="nx">options</span><span class="p">.</span><span class="nx">duration</span>
      <span class="nv">complete: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">complete</span><span class="o">?</span>
          <span class="nx">options</span><span class="p">.</span><span class="nx">complete</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>
    <span class="p">)</span>
    
<span class="k">class</span> <span class="nx">effects</span><span class="p">.</span><span class="nx">CSSTransition</span>
  <span class="nx">constructor</span><span class="o">:</span><span class="nf">(@options) -&gt;</span>
    <span class="vi">@transitionEndStr = </span><span class="nx">transitionEndNames</span><span class="p">[</span><span class="nx">getProp</span><span class="p">(</span><span class="s1">&#39;Transition&#39;</span><span class="p">)]</span>
    <span class="vi">@numTransitions = </span><span class="mi">0</span>
    <span class="vi">@numTransitionsComplete = </span><span class="mi">0</span>
    <span class="nv">elements = </span><span class="p">[]</span>
    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if jQuery object</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">target</span> <span class="k">instanceof</span> <span class="nx">jQuery</span>       
      <span class="k">for</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">target</span>
        <span class="nx">elements</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">@options</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">i</span><span class="p">))</span>           </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if an Array    </p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span> <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">is</span> <span class="nb">Array</span>
      <span class="nv">elements = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">target</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>otherwise target was a HTMLElement in the first place  </p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span>
      <span class="nv">elements = </span><span class="p">[</span><span class="nx">@options</span><span class="p">.</span><span class="nx">target</span><span class="p">]</span>
    
    <span class="nx">@transition</span><span class="p">(</span><span class="nx">elements</span><span class="p">)</span>
  
  <span class="nv">transition: </span><span class="p">(</span><span class="nx">elements</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">for</span> <span class="nx">element</span> <span class="k">in</span> <span class="nx">elements</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>iterate over each CSS property and apply to HTMLElement</p></div></div><div class="code"><div class="wrapper">      <span class="k">for</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">props</span>
        <span class="nx">@numTransitions</span><span class="o">++</span>
        <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">duration</span> <span class="o">&gt;</span> <span class="mi">0</span>
          <span class="nx">element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">@transitionEndStr</span><span class="p">,</span> <span class="nx">@onTransitionEnd</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="nx">@onTransitionEnd</span><span class="p">(</span><span class="nv">target: </span><span class="nx">element</span><span class="p">)</span>
        
        <span class="k">new</span> <span class="nx">effects</span><span class="p">.</span><span class="nx">TransitionDelegate</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">duration</span><span class="p">)</span>
    
  <span class="nv">onTransitionEnd: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">@transitionEndStr</span><span class="p">,</span> <span class="nx">@onTransitionEnd</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="nx">@numTransitionsComplete</span><span class="o">++</span>
    <span class="k">if</span> <span class="nx">@numTransitionsComplete</span> <span class="o">is</span> <span class="nx">@numTransitions</span>      
      <span class="k">if</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">complete</span><span class="o">?</span>
        <span class="nx">@options</span><span class="p">.</span><span class="nx">complete</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="err">@</span><span class="p">)</span>

<span class="k">class</span> <span class="nx">effects</span><span class="p">.</span><span class="nx">TransitionDelegate</span>       
  <span class="nv">constructor: </span><span class="nf">(@element, @property, @value, @duration) -&gt;</span>    </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if duration, add "transitionEnd" listener</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@duration</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">transitionEndNames</span><span class="p">[</span><span class="nx">getProp</span><span class="p">(</span><span class="s1">&#39;Transition&#39;</span><span class="p">)],</span> <span class="nx">@onTransitionEnd</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
        </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add the transition CSS properties</p></div></div><div class="code"><div class="wrapper">    <span class="nx">@addTransitionStyles</span><span class="p">()</span>
    <span class="nx">@addStyles</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>no duration so fire callback immediately</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">@duration</span> <span class="o">is</span> <span class="mi">0</span>
      <span class="nx">@onTransitionEnd</span><span class="p">()</span>
  
  <span class="nv">addStyles: </span><span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if height or width and transitioning to "auto" size</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="p">(</span><span class="nx">@property</span> <span class="o">is</span> <span class="s2">&quot;height&quot;</span> <span class="o">or</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@value</span> <span class="o">is</span> <span class="s2">&quot;auto&quot;</span>         
      <span class="nv">size = </span><span class="nx">@getClientAutoSize</span><span class="p">(</span><span class="nx">@element</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set to actual height/width - "auto" will be added back again once transition is complete</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">@property</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#{if @property is &quot;</span><span class="nx">height</span><span class="s2">&quot; then size.height else size.width}px&quot;</span>
      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if we're animating from "auto" width to any other value</p></div></div><div class="code"><div class="wrapper">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">@property</span> <span class="o">is</span> <span class="s2">&quot;height&quot;</span> <span class="o">or</span> <span class="s2">&quot;width&quot;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">@property</span><span class="p">]</span> <span class="o">is</span> <span class="s2">&quot;auto&quot;</span>      </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>ditch the transition styling temporarily to prevent unwanted animation</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@removeTransitionStyles</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set the element to it's actual width/height</p></div></div><div class="code"><div class="wrapper">      <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">@property</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#{if @property is &quot;</span><span class="nx">height</span><span class="s2">&quot; then @element.clientHeight else @element.clientWidth}px&quot;</span> </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>wait 15ms for DOM to update</p></div></div><div class="code"><div class="wrapper">      <span class="nx">setTimeout</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>add the transition style back</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@addTransitionStyles</span><span class="p">()</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>set new value</p></div></div><div class="code"><div class="wrapper">        <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">@property</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#{@value}px&quot;</span>
      <span class="p">,</span> <span class="mi">50</span>
    <span class="k">else</span>
      <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">@property</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#{@value+@pxMap(@property)}&quot;</span>
  
  <span class="nv">getClientAutoSize: </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">clone = </span><span class="nx">element</span><span class="p">.</span><span class="nx">cloneNode</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="nv">body = </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
    <span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">clone</span><span class="p">)</span>
    <span class="nv">clone.style.width = </span><span class="s2">&quot;auto&quot;</span>
    <span class="nv">clone.style.height = </span><span class="s2">&quot;auto&quot;</span>
    <span class="nv">clone.style.visibility = </span><span class="s2">&quot;hidden&quot;</span>
    <span class="nv">clone.style.display = </span><span class="s2">&quot;block&quot;</span>
    <span class="nv">size =</span>
      <span class="nv">width: </span><span class="nx">clone</span><span class="p">.</span><span class="nx">clientWidth</span>
      <span class="nv">height: </span><span class="nx">clone</span><span class="p">.</span><span class="nx">clientHeight</span>
    <span class="nx">body</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">clone</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">size</span>
     
  <span class="nv">onTransitionEnd: </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>if there was an event, remove the listener</p></div></div><div class="code"><div class="wrapper">    <span class="k">if</span> <span class="nx">e</span><span class="o">?</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">type</span><span class="p">,</span> <span class="nx">@onTransitionEnd</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span></div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>remove </p></div></div><div class="code"><div class="wrapper">    <span class="nx">@removeTransitionStyles</span><span class="p">()</span>  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>reset to "auto" if needed</p></div></div><div class="code"><div class="wrapper">    
    <span class="k">if</span> <span class="nx">@value</span> <span class="o">is</span> <span class="s2">&quot;auto&quot;</span>
      <span class="k">if</span> <span class="nx">@property</span> <span class="o">is</span> <span class="s2">&quot;height&quot;</span> <span class="o">or</span> <span class="s2">&quot;width&quot;</span>
        <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">@property</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span>

  <span class="nv">addTransitionStyles: </span><span class="o">=&gt;</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;#{getProp(&#39;TransitionProperty&#39;)}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>  
    <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;#{getProp(&#39;TransitionDuration&#39;)}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;#{@duration / 1000}s&quot;</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;#{getProp(&#39;TransitionTimingFunction&#39;)}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ease-in-out&quot;</span>
  
  <span class="nv">removeTransitionStyles: </span><span class="o">=&gt;</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;#{getProp(&#39;TransitionProperty&#39;)}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;#{getProp(&#39;TransitionDuration&#39;)}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="s2">&quot;#{getProp(&#39;TransitionTimingFunction&#39;)}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  </div></div></div><div class="segment"><div class="comments"><div class="wrapper"><p>utility function, returns "px" if obj in array</p></div></div><div class="code"><div class="wrapper">  <span class="nv">pxMap: </span><span class="nf">(obj) -&gt;</span>
    <span class="nv">suffix = </span><span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="s2">&quot;bottom&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="s2">&quot;height&quot;</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">obj</span> <span class="o">is</span> <span class="nx">prop</span> <span class="k">then</span> <span class="nv">suffix = </span><span class="s2">&quot;px&quot;</span>
    <span class="k">return</span> <span class="nx">suffix</span>

                                     </div></div></div></div></body></html>